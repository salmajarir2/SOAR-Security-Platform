<!--
  Custom Wazuh Rules for SOAR Security Platform
  These rules provide advanced threat detection capabilities
  mapped to MITRE ATT&CK framework tactics and techniques
-->

<group name="soar_custom,attack,">
  
  <!-- SSH Brute Force Attack Detection -->
  <rule id="100001" level="10" frequency="6" timeframe="240" ignore="60">
    <if_matched_sid>5716</if_matched_sid>
    <description>SSH brute force attack detected (multiple failed logins)</description>
    <mitre>
      <id>T1110.001</id>
      <tactic>Credential Access</tactic>
      <technique>Brute Force: Password Guessing</technique>
    </mitre>
    <options>no_email_alert</options>
  </rule>

  <!-- Successful SSH Login After Failed Attempts -->
  <rule id="100002" level="12">
    <if_matched_sid>100001</if_matched_sid>
    <if_sid>5715</if_sid>
    <description>Successful SSH login after brute force attempts</description>
    <mitre>
      <id>T1078</id>
      <tactic>Defense Evasion,Persistence,Privilege Escalation,Initial Access</tactic>
      <technique>Valid Accounts</technique>
    </mitre>
  </rule>

  <!-- Web Application Attack Detection -->
  <rule id="100003" level="8">
    <if_sid>31100,31101,31102,31103,31104,31105,31106,31107,31108,31109</if_sid>
    <url>union|select|insert|update|delete|drop|create|alter|exec|script|javascript|vbscript|onload|onerror</url>
    <description>SQL injection or XSS attack attempt detected</description>
    <mitre>
      <id>T1190</id>
      <tactic>Initial Access</tactic>
      <technique>Exploit Public-Facing Application</technique>
    </mitre>
  </rule>

  <!-- Multiple Web Application Attacks from Same Source -->
  <rule id="100004" level="12" frequency="5" timeframe="300">
    <if_matched_sid>100003</if_matched_sid>
    <same_source_ip />
    <description>Multiple web application attacks from same source IP</description>
    <mitre>
      <id>T1190</id>
      <tactic>Initial Access</tactic>
      <technique>Exploit Public-Facing Application</technique>
    </mitre>
  </rule>

  <!-- Suspicious File Access Patterns -->
  <rule id="100005" level="9">
    <if_sid>550,554</if_sid>
    <field name="file">\.passwd$|\.shadow$|/etc/passwd|/etc/shadow|\.ssh/|\.aws/|\.kube/</field>
    <description>Access to sensitive system files detected</description>
    <mitre>
      <id>T1005</id>
      <tactic>Collection</tactic>
      <technique>Data from Local System</technique>
    </mitre>
  </rule>

  <!-- Privilege Escalation Attempts -->
  <rule id="100006" level="11">
    <if_sid>5401,5402</if_sid>
    <field name="command">sudo|su -|chmod 777|chown root|passwd root</field>
    <description>Privilege escalation attempt detected</description>
    <mitre>
      <id>T1068</id>
      <tactic>Privilege Escalation</tactic>
      <technique>Exploitation for Privilege Escalation</technique>
    </mitre>
  </rule>

  <!-- Suspicious Network Connections -->
  <rule id="100007" level="8">
    <if_sid>2501,2502</if_sid>
    <field name="protocol">tcp</field>
    <field name="dstport">4444|5555|6666|7777|8888|9999</field>
    <description>Connection to suspicious high port detected (possible backdoor)</description>
    <mitre>
      <id>T1571</id>
      <tactic>Command and Control</tactic>
      <technique>Non-Standard Port</technique>
    </mitre>
  </rule>

  <!-- Malware Hash Detection -->
  <rule id="100008" level="13">
    <if_sid>657,658</if_sid>
    <list field="md5" lookup="match_key">etc/lists/malware_hashes</list>
    <description>Known malware hash detected</description>
    <mitre>
      <id>T1204</id>
      <tactic>Execution</tactic>
      <technique>User Execution</technique>
    </mitre>
  </rule>

  <!-- Suspicious Process Creation -->
  <rule id="100009" level="10">
    <if_sid>200</if_sid>
    <field name="command">powershell.exe -enc|cmd.exe /c|wscript.exe|cscript.exe|regsvr32.exe|rundll32.exe</field>
    <description>Suspicious process execution detected</description>
    <mitre>
      <id>T1059</id>
      <tactic>Execution</tactic>
      <technique>Command and Scripting Interpreter</technique>
    </mitre>
  </rule>

  <!-- Data Exfiltration Detection -->
  <rule id="100010" level="11">
    <if_sid>2501</if_sid>
    <field name="protocol">tcp</field>
    <field name="dstport">21|22|443|80</field>
    <field name="data_size">^[1-9]\d{6,}</field>
    <description>Large data transfer detected (possible data exfiltration)</description>
    <mitre>
      <id>T1041</id>
      <tactic>Exfiltration</tactic>
      <technique>Exfiltration Over C2 Channel</technique>
    </mitre>
  </rule>

  <!-- Lateral Movement Detection -->
  <rule id="100011" level="10">
    <if_sid>5156</if_sid>
    <field name="protocol">tcp</field>
    <field name="dstport">135|445|3389</field>
    <description>Lateral movement attempt detected</description>
    <mitre>
      <id>T1021</id>
      <tactic>Lateral Movement</tactic>
      <technique>Remote Services</technique>
    </mitre>
  </rule>

  <!-- Credential Dumping Detection -->
  <rule id="100012" level="12">
    <if_sid>5145</if_sid>
    <field name="file">SYSTEM|SAM|SECURITY|NTDS.dit</field>
    <description>Credential dumping attempt detected</description>
    <mitre>
      <id>T1003</id>
      <tactic>Credential Access</tactic>
      <technique>OS Credential Dumping</technique>
    </mitre>
  </rule>

  <!-- Persistence Mechanism Detection -->
  <rule id="100013" level="10">
    <if_sid>61603,61604</if_sid>
    <field name="key">Run|RunOnce|Winlogon|Services</field>
    <description>Registry persistence mechanism detected</description>
    <mitre>
      <id>T1547.001</id>
      <tactic>Persistence,Privilege Escalation</tactic>
      <technique>Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder</technique>
    </mitre>
  </rule>

  <!-- DNS Tunneling Detection -->
  <rule id="100014" level="9">
    <if_sid>2503</if_sid>
    <field name="query_length">^[5-9]\d|^[1-9]\d{2,}</field>
    <description>Suspicious DNS query detected (possible DNS tunneling)</description>
    <mitre>
      <id>T1071.004</id>
      <tactic>Command and Control</tactic>
      <technique>Application Layer Protocol: DNS</technique>
    </mitre>
  </rule>

  <!-- Anti-Virus/EDR Evasion -->
  <rule id="100015" level="11">
    <if_sid>5145</if_sid>
    <field name="process">taskkill|net stop|sc stop</field>
    <field name="target">windefend|symantec|mcafee|kaspersky|avast|avg</field>
    <description>Security software evasion attempt detected</description>
    <mitre>
      <id>T1562.001</id>
      <tactic>Defense Evasion</tactic>
      <technique>Impair Defenses: Disable or Modify Tools</technique>
    </mitre>
  </rule>

  <!-- Suspicious PowerShell Activity -->
  <rule id="100016" level="10">
    <if_sid>91533</if_sid>
    <field name="command">Invoke-Expression|IEX|downloadstring|Net.WebClient|Start-Process -WindowStyle Hidden</field>
    <description>Suspicious PowerShell activity detected</description>
    <mitre>
      <id>T1059.001</id>
      <tactic>Execution</tactic>
      <technique>Command and Scripting Interpreter: PowerShell</technique>
    </mitre>
  </rule>

  <!-- Living Off The Land Binary (LOLBin) Detection -->
  <rule id="100017" level="9">
    <if_sid>200</if_sid>
    <field name="command">bitsadmin|certutil|regasm|regsvcs|installutil|mshta|forfiles</field>
    <description>Living off the land binary usage detected</description>
    <mitre>
      <id>T1218</id>
      <tactic>Defense Evasion</tactic>
      <technique>Signed Binary Proxy Execution</technique>
    </mitre>
  </rule>

  <!-- DLL Side-Loading Detection -->
  <rule id="100018" level="10">
    <if_sid>7045</if_sid>
    <field name="image">System32</field>
    <not>
      <field name="loaded_image">System32</field>
    </not>
    <description>DLL side-loading attempt detected</description>
    <mitre>
      <id>T1574.002</id>
      <tactic>Persistence,Privilege Escalation,Defense Evasion</tactic>
      <technique>Hijack Execution Flow: DLL Side-Loading</technique>
    </mitre>
  </rule>

  <!-- Shadow Copy Deletion -->
  <rule id="100019" level="12">
    <if_sid>5145</if_sid>
    <field name="command">vssadmin delete shadows|wbadmin delete catalog|wmic shadowcopy delete</field>
    <description>Shadow copy deletion detected (possible ransomware activity)</description>
    <mitre>
      <id>T1490</id>
      <tactic>Impact</tactic>
      <technique>Inhibit System Recovery</technique>
    </mitre>
  </rule>

  <!-- Scheduled Task Creation for Persistence -->
  <rule id="100020" level="9">
    <if_sid>106</if_sid>
    <field name="task_name">Microsoft|Windows|Update</field>
    <description>Suspicious scheduled task created for persistence</description>
    <mitre>
      <id>T1053.005</id>
      <tactic>Execution,Persistence,Privilege Escalation</tactic>
      <technique>Scheduled Task/Job: Scheduled Task</technique>
    </mitre>
  </rule>

  <!-- WMI Event Subscription -->
  <rule id="100021" level="10">
    <if_sid>19,20,21</if_sid>
    <description>WMI event subscription detected (possible persistence mechanism)</description>
    <mitre>
      <id>T1546.003</id>
      <tactic>Privilege Escalation,Persistence</tactic>
      <technique>Event Triggered Execution: Windows Management Instrumentation Event Subscription</technique>
    </mitre>
  </rule>

  <!-- Process Hollowing Detection -->
  <rule id="100022" level="12">
    <if_sid>1,8</if_sid>
    <field name="process_state">suspended</field>
    <field name="write_process_memory">true</field>
    <description>Process hollowing technique detected</description>
    <mitre>
      <id>T1055.012</id>
      <tactic>Defense Evasion,Privilege Escalation</tactic>
      <technique>Process Injection: Process Hollowing</technique>
    </mitre>
  </rule>

  <!-- Suspicious Network Scanner Activity -->
  <rule id="100023" level="8" frequency="20" timeframe="60">
    <if_sid>2501</if_sid>
    <field name="dstport">22|23|80|443|135|445|1433|3389</field>
    <same_source_ip />
    <description>Network scanning activity detected from single source</description>
    <mitre>
      <id>T1046</id>
      <tactic>Discovery</tactic>
      <technique>Network Service Scanning</technique>
    </mitre>
  </rule>

  <!-- Kerberoasting Detection -->
  <rule id="100024" level="11">
    <if_sid>4769</if_sid>
    <field name="service_name">^[A-Za-z0-9]+\/[A-Za-z0-9.-]+</field>
    <field name="ticket_encryption_type">0x17</field>
    <description>Kerberoasting attack detected</description>
    <mitre>
      <id>T1558.003</id>
      <tactic>Credential Access</tactic>
      <technique>Steal or Forge Kerberos Tickets: Kerberoasting</technique>
    </mitre>
  </rule>

  <!-- Golden Ticket Detection -->
  <rule id="100025" level="13">
    <if_sid>4624</if_sid>
    <field name="logon_type">3</field>
    <field name="account">krbtgt</field>
    <description>Golden ticket attack detected</description>
    <mitre>
      <id>T1558.001</id>
      <tactic>Credential Access</tactic>
      <technique>Steal or Forge Kerberos Tickets: Golden Ticket</technique>
    </mitre>
  </rule>

  <!-- DCSync Attack Detection -->
  <rule id="100026" level="12">
    <if_sid>4662</if_sid>
    <field name="access_mask">0x100</field>
    <field name="object_type">domainDNS</field>
    <field name="properties">1131f6aa-9c07-11d1-f79f-00c04fc2dcd2|1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</field>
    <description>DCSync attack detected</description>
    <mitre>
      <id>T1003.006</id>
      <tactic>Credential Access</tactic>
      <technique>OS Credential Dumping: DCSync</technique>
    </mitre>
  </rule>

  <!-- Suspicious Email Attachment -->
  <rule id="100027" level="9">
    <if_sid>12300</if_sid>
    <field name="attachment">\.exe$|\.scr$|\.bat$|\.cmd$|\.pif$|\.vbs$|\.js$|\.jar$|\.zip$</field>
    <description>Suspicious email attachment detected</description>
    <mitre>
      <id>T1566.001</id>
      <tactic>Initial Access</tactic>
      <technique>Phishing: Spearphishing Attachment</technique>
    </mitre>
  </rule>

  <!-- Cryptocurrency Mining Detection -->
  <rule id="100028" level="8">
    <if_sid>2501</if_sid>
    <field name="dstport">3333|4444|8333|9999</field>
    <field name="dstip">pool\.|mining\.|stratum\.</field>
    <description>Cryptocurrency mining activity detected</description>
    <mitre>
      <id>T1496</id>
      <tactic>Impact</tactic>
      <technique>Resource Hijacking</technique>
    </mitre>
  </rule>

  <!-- RDP Brute Force -->
  <rule id="100029" level="10" frequency="6" timeframe="240">
    <if_sid>60122</if_sid>
    <same_source_ip />
    <description>RDP brute force attack detected</description>
    <mitre>
      <id>T1110.001</id>
      <tactic>Credential Access</tactic>
      <technique>Brute Force: Password Guessing</technique>
    </mitre>
  </rule>

  <!-- USB Device Insertion -->
  <rule id="100030" level="6">
    <if_sid>20001</if_sid>
    <field name="device_type">USB</field>
    <description>USB device insertion detected</description>
    <mitre>
      <id>T1091</id>
      <tactic>Initial Access</tactic>
      <technique>Replication Through Removable Media</technique>
    </mitre>
  </rule>

</group>